description: |
  This flow takes 'input_table_name' as a parameter. The table must contain sfdc_id column with the Salesforce Account IDs to be deleted
steps:
  - op: http_request
    id: delete_accounts
    for_each:
      source: "stage"
      table: "{{ var('input_table_name') }}"
      as: account
    request:
      source: "salesforce_rest"
      url: "{{ var('sfdc_instance_url') }}/services/data/{{ var('api_version') }}/sobjects/Account/{{ var('account')['sfdc_id'] }}"
      method: DELETE
      headers:
        "Accept": "application/json"
        "Content-Type": "application/json"
    response:
      parser_expression: |
        def evaluate(context, response):
          if response.status_code != 204:
            raise Exception(f"Error status code: {response.status_code}, body: {response.text}")
          record = {
            "sfdc_id": context.var("account").get("sfdc_id"),
          }
          return {
            "tables": [{  
              "source": "stage",
              "table": "sfdc_accounts_deleted",
              "data": [record],  
              "model": {
                "columns": [
                {"name": "sfdc_id", "type": "text"}
                ]
              }
            }]
          }
