steps:
  - op: http_request
    id: get_customers
    init:
      variables:
        next_page: 1 # start from page 1
    request:
      source: "bigcommerce"
      url: "https://api.bigcommerce.com/stores/{{ var('store_hash') }}/{{ var('api_version') }}/customers"
      method: GET
      parameters:
        limit: 5 # small for testing, use 1000 for production
        page_expression: var("next_page")
      headers:
        "Accept": "application/json"
    response:
      success_status: [200]
      tables: 
        - source: "stage"
          table: "bc_customers"
          columns: {"id": "text", "first_name": "text", "last_name": "text"}
          data_expression: response.json()["data"]
      variables:
        next_page_expression: response.json()["meta"]["pagination"]["current_page"] + 1 
      while_expression: |
        pagination = response.json()["meta"]["pagination"]
        current_page = pagination["current_page"];
        total_pages = pagination["total_pages"];
        return current_page < total_pages