steps:
  - op: http_request
    id: get_customers
    request:
      source: "shopify"
      url: "https://{{ var('store_name') }}.myshopify.com/admin/api/{{ var('api_version') }}/customers.json"
      method: GET
      headers:
        "Accept": "application/json"
    response:
      parser_expression: |
        def evaluate(context, response):
          if response.status_code != 200:
            raise "Error response code: " + str(response.status_code)
          customers = response.json()['customers']
          
          customer_addresses = []
          for customer in customers:
            # flattening the nested object
            customer['email_consent_state'] = customer['email_marketing_consent']['state'] 
            customer['opt_in_level'] = customer['email_marketing_consent'].get('single_opt_in') 
            
            # extract nested list of addresses and add customer_id to each address for reference
            for address in customer['addresses']:
              # in Shopify each address already has a customer_id field but we assume they don't to demonstrate enriching the data with reference to the customer
              address['customer_id'] = customer['id'] 
              customer_addresses.append(address)
          return {
            "tables": [
              {  
                "source": "stage",
                "table": "shopify_customers",
                "data": customers,  
                "model": {
                  "columns": [
                  {"name": "id", "type": "text"},
                  {"name": "first_name", "type": "text"},
                  {"name": "last_name", "type": "text"},
                  {"name": "email", "type": "text"}
                  ]
                }
              },
              {  
                "source": "stage",
                "table": "shopify_customer_addresses",
                "data": customer_addresses,  
                "model": {
                  "columns": [
                  {"name": "id", "type": "text"},
                  {"name": "customer_id", "type": "text"},
                  {"name": "address1", "type": "text"},
                  {"name": "address2", "type": "text"},
                  {"name": "city", "type": "text"},
                  {"name": "province", "type": "text"},
                  {"name": "zip", "type": "text"},
                  {"name": "country", "type": "text"}
                  ]
                }
              }
            ]
          }
